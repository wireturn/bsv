package spv_test

import (
	"context"
	"errors"
	"fmt"
	"testing"

	"github.com/libsv/go-bc"
	"github.com/libsv/go-bc/spv"
	"github.com/libsv/go-bt/v2"
	"github.com/stretchr/testify/assert"
)

type mockTxMerkleGetter struct {
	txStoreFunc func(context.Context, string) (*bt.Tx, error)
	mpStoreFunc func(context.Context, string) (*bc.MerkleProof, error)
}

func (m *mockTxMerkleGetter) Tx(ctx context.Context, txID string) (*bt.Tx, error) {
	if m.txStoreFunc == nil {
		return nil, errors.New("txGetterFunc in test is undefined")
	}

	return m.txStoreFunc(ctx, txID)
}

func (m *mockTxMerkleGetter) MerkleProof(ctx context.Context, txID string) (*bc.MerkleProof, error) {
	if m.txStoreFunc == nil {
		return nil, errors.New("mpGetterFunc in test is undefined")
	}

	return m.mpStoreFunc(ctx, txID)
}

func TestSPVEnvelope_CreateEnvelope(t *testing.T) {
	tests := map[string]struct {
		tx     string
		txFunc func(context.Context, string) (*bt.Tx, error)
		mpFunc func(context.Context, string) (*bc.MerkleProof, error)
		exp    spv.Envelope
		expErr error
	}{
		"valid envelope created": {
			tx: "0200000005c931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea000000006a473044022011dd49f90eb34195e61712cef41d16ce9496807124b1e1c6205cb06ccfdbef0002203b2553032d166724d89a42a12b997cb1c4a78c4d8bbc72f94ab9ef4c3db36d38412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffffc931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea010000006b483045022100f8a92d8e09a239d863b57c44fd2915558afbe05074c992b72639288f15a5a928022047399d49fcc7354140ecec229fe682383a9e9c59e43da368d35d211a06a17f2641210363d67968518ee1c0485b9b95544c0a9ec8c280b649b72c74fe86c299cd055a3bfeffffff250d555b731c8ba2843781d812f1aefbad643665864f29eef18f0b65b77ca9a7010000006b483045022100ece110a2ae06c67f3d4b25ad4ec2d7acf85fa1618dabef9d7eed5b4e5c50bbea02207716c2a9dd8d1ce64a56a3377eb35892db42dbba62058ebeb1b14ca33a8b98c241210241f2c990d7e0fe5c1c5e4508883b76b9786fcc67ccee1b8724eefa89a8f32981feffffff4713da1eacb49f37bd414205706229ddd8a85639a864c063fd2fd1a943ee1569010000006b483045022100831aac063f1b32f9e5645c5442a6b15cb620c6c49930f0194fa6acf6c864f48202203a8cc93d8bcd6f7d86cac0c7c99485cc1837fc87790f13f5bbf2f3b901e86be341210376c2519a09f7cfbcbe000f823c1e957cadace64296e907ae1ea36536313f0706feffffffcb551ea63f1903d74888a1f8989fb521df1567740a0edcf862fbd4f372783236010000006b483045022100f0fa4ab61952f5497d4dfe6b7a4e5e9b3305a5b94b0d7a6d1536927dfea2aa4202205eaa36045812bf5561c9e3a38fc92e6d89908637a5c0ec250a843f36355418c2412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff02bccdf505000000001976a914349256bff9dbe79285454d0e55d1a3163bd6dff888ac0084d717000000001976a914e2e4d329a79401e0a713210a4c615abdc540eda888ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9":
					return bt.NewTxFromString("02000000022082b13cb07c06d360773aca3ee9fe8bc5d73f8ad0e3698cc2e23e83bc2f3dc1000000006b483045022100a5c4b36223100189519957f41ae4ec345e4e2782f567d46504c4a432e523b34802203598789197f91e06a136e7dd16e163669de3b03123497f6d8a9a266be975a4df412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549010000006a473044022007a2fc274ace708d919fcd79ac134f8acf47a9ce6e10795e1c6a51548684ea9e022017cd7982c3b86bf874b3aaaa5324241b415fc4c299463b072074bdbac367ef8c412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a914863189af8516a85b2a12db0119540070c977a18288ac67000000")
				case "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25":
					return bt.NewTxFromString("0200000002fa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1010000006b483045022100c406943f8804eed1a4021d6f7b91c3f9b294b43b1bde8f221d395b503c312e390220351399f0ccafa9a469dd280317903168d2c4a0623440c828451711c8e4d9e24241210348ec9620f94ce08b6c422fc08e5156a4fa23229cdab9608065baf3a0ba33391bfeffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549000000006a4730440220658519a33702c58c6556be863f324b705cf7e6e8b7f255356351531d7064028002204c16dc99b12d7202f0e56a32408433425f48b67d22be9d491f843e51cb84c5fc4121020cbd8a7a8cac2f87a8e606061569e89488416af21967a2da635fe25ee157f5fdfeffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88acdad3f505000000001976a914e3e56e8e16fc7a694cdd585dac37a5c26dbae93688ac67000000")
				case "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347":
					return bt.NewTxFromString("02000000028c8200863359b5bb9fe8a9537529fb27f289081dc182aecca6eec67c9dc810ec000000006b48304502210093802a05a1ec6483711bb1e62388e3adfe2187dc87d61b153d1f86bc4bc3a2a0022044fae573bc835851d0989fca28d554fafdb5ae9e62c11a9029f3ed26f92723e0412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15fefffffffa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1000000006b4830450221008c9d8d17e80a350d5b6685bd71618a2ff23919e6f4f802b955578c25ffc9bcc2022066396b37d2c4437b222903af476cae129c9bc95e398713d3d1ee68ebe47991e3412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a9144f0de48ccfea5dd8b01a95ade7fbe69842c5755988ac67000000")
				case "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb":
					return bt.NewTxFromString("0200000001e65bf7813ee5bf1793a3487c2701f73b1b47f56fe7f7f36d7ee64b8987563f42000000004847304402206a9fe9ae02ecc95f8a90833707f9d04574618c6b9bb70ec67e5a16c1d04e08090220524fff062a60f03bf6560b392791b73982331f75e72afdd51a0b1d58d9bffe3e41feffffff0240101024010000001976a9144685874765a3e652d6869f5651d19000302275a888ac00e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac67000000")
				default:
					return nil, fmt.Errorf("txid %s not defined for test", txID)
				}
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"2a65d19f8d29ce53beb0f0e636a1d7b368d5c87b67cd3164277a7d29b66a636e": nil,
					"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9": {
						Index:  9,
						TxOrID: "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25": {
						Index:  10,
						TxOrID: "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347": {
						Index:  10,
						TxOrID: "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"1040bbc6a17d8f6ce78c99ee80139647ab946613645d0076c4f79a63f480b1a0",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb": {
						Index:  7,
						TxOrID: "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"c13d2fbc833ee2c28c69e3d08a3fd7c58bfee93eca3a7760d3067cb03cb18220",
							"87b322ba2397a30f22a91e256ec07e3654a410df2c69d03eb496d13b65c58329",
							"70ff03adf845a2b65ab5de530e6f42ab6dd42bd26d92077476bd66266f4635fb",
							"3ef5795dfb057a047eec84a2a46b2fab0bf23486b0c70fff6f977dcaed55dda2",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			exp: spv.Envelope{
				TxID:  "2a65d19f8d29ce53beb0f0e636a1d7b368d5c87b67cd3164277a7d29b66a636e",
				RawTx: "0200000005c931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea000000006a473044022011dd49f90eb34195e61712cef41d16ce9496807124b1e1c6205cb06ccfdbef0002203b2553032d166724d89a42a12b997cb1c4a78c4d8bbc72f94ab9ef4c3db36d38412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffffc931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea010000006b483045022100f8a92d8e09a239d863b57c44fd2915558afbe05074c992b72639288f15a5a928022047399d49fcc7354140ecec229fe682383a9e9c59e43da368d35d211a06a17f2641210363d67968518ee1c0485b9b95544c0a9ec8c280b649b72c74fe86c299cd055a3bfeffffff250d555b731c8ba2843781d812f1aefbad643665864f29eef18f0b65b77ca9a7010000006b483045022100ece110a2ae06c67f3d4b25ad4ec2d7acf85fa1618dabef9d7eed5b4e5c50bbea02207716c2a9dd8d1ce64a56a3377eb35892db42dbba62058ebeb1b14ca33a8b98c241210241f2c990d7e0fe5c1c5e4508883b76b9786fcc67ccee1b8724eefa89a8f32981feffffff4713da1eacb49f37bd414205706229ddd8a85639a864c063fd2fd1a943ee1569010000006b483045022100831aac063f1b32f9e5645c5442a6b15cb620c6c49930f0194fa6acf6c864f48202203a8cc93d8bcd6f7d86cac0c7c99485cc1837fc87790f13f5bbf2f3b901e86be341210376c2519a09f7cfbcbe000f823c1e957cadace64296e907ae1ea36536313f0706feffffffcb551ea63f1903d74888a1f8989fb521df1567740a0edcf862fbd4f372783236010000006b483045022100f0fa4ab61952f5497d4dfe6b7a4e5e9b3305a5b94b0d7a6d1536927dfea2aa4202205eaa36045812bf5561c9e3a38fc92e6d89908637a5c0ec250a843f36355418c2412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff02bccdf505000000001976a914349256bff9dbe79285454d0e55d1a3163bd6dff888ac0084d717000000001976a914e2e4d329a79401e0a713210a4c615abdc540eda888ac68000000",
				Parents: map[string]*spv.Envelope{
					"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9": {
						TxID:  "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
						RawTx: "02000000022082b13cb07c06d360773aca3ee9fe8bc5d73f8ad0e3698cc2e23e83bc2f3dc1000000006b483045022100a5c4b36223100189519957f41ae4ec345e4e2782f567d46504c4a432e523b34802203598789197f91e06a136e7dd16e163669de3b03123497f6d8a9a266be975a4df412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549010000006a473044022007a2fc274ace708d919fcd79ac134f8acf47a9ce6e10795e1c6a51548684ea9e022017cd7982c3b86bf874b3aaaa5324241b415fc4c299463b072074bdbac367ef8c412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a914863189af8516a85b2a12db0119540070c977a18288ac67000000",
						Proof: &bc.MerkleProof{
							Index:  9,
							TxOrID: "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
							Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
							Nodes: []string{
								"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
								"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
								"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
								"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
							},
						},
					},
					"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25": {
						TxID:  "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
						RawTx: "0200000002fa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1010000006b483045022100c406943f8804eed1a4021d6f7b91c3f9b294b43b1bde8f221d395b503c312e390220351399f0ccafa9a469dd280317903168d2c4a0623440c828451711c8e4d9e24241210348ec9620f94ce08b6c422fc08e5156a4fa23229cdab9608065baf3a0ba33391bfeffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549000000006a4730440220658519a33702c58c6556be863f324b705cf7e6e8b7f255356351531d7064028002204c16dc99b12d7202f0e56a32408433425f48b67d22be9d491f843e51cb84c5fc4121020cbd8a7a8cac2f87a8e606061569e89488416af21967a2da635fe25ee157f5fdfeffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88acdad3f505000000001976a914e3e56e8e16fc7a694cdd585dac37a5c26dbae93688ac67000000",
						Proof: &bc.MerkleProof{
							Index:  10,
							TxOrID: "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
							Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
							Nodes: []string{
								"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
								"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
								"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
								"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
							},
						},
					},
					"6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347": {
						TxID:  "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
						RawTx: "02000000028c8200863359b5bb9fe8a9537529fb27f289081dc182aecca6eec67c9dc810ec000000006b48304502210093802a05a1ec6483711bb1e62388e3adfe2187dc87d61b153d1f86bc4bc3a2a0022044fae573bc835851d0989fca28d554fafdb5ae9e62c11a9029f3ed26f92723e0412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15fefffffffa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1000000006b4830450221008c9d8d17e80a350d5b6685bd71618a2ff23919e6f4f802b955578c25ffc9bcc2022066396b37d2c4437b222903af476cae129c9bc95e398713d3d1ee68ebe47991e3412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a9144f0de48ccfea5dd8b01a95ade7fbe69842c5755988ac67000000",
						Proof: &bc.MerkleProof{
							Index:  10,
							TxOrID: "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
							Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
							Nodes: []string{
								"1040bbc6a17d8f6ce78c99ee80139647ab946613645d0076c4f79a63f480b1a0",
								"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
								"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
							},
						},
					},
					"36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb": {
						TxID:  "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
						RawTx: "0200000001e65bf7813ee5bf1793a3487c2701f73b1b47f56fe7f7f36d7ee64b8987563f42000000004847304402206a9fe9ae02ecc95f8a90833707f9d04574618c6b9bb70ec67e5a16c1d04e08090220524fff062a60f03bf6560b392791b73982331f75e72afdd51a0b1d58d9bffe3e41feffffff0240101024010000001976a9144685874765a3e652d6869f5651d19000302275a888ac00e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac67000000",
						Proof: &bc.MerkleProof{
							Index:  7,
							TxOrID: "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
							Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
							Nodes: []string{
								"c13d2fbc833ee2c28c69e3d08a3fd7c58bfee93eca3a7760d3067cb03cb18220",
								"87b322ba2397a30f22a91e256ec07e3654a410df2c69d03eb496d13b65c58329",
								"70ff03adf845a2b65ab5de530e6f42ab6dd42bd26d92077476bd66266f4635fb",
								"3ef5795dfb057a047eec84a2a46b2fab0bf23486b0c70fff6f977dcaed55dda2",
							},
						},
					},
				},
			},
		},
		"creating an envelope with tx that doesn't exist errors": {
			tx: "0200000005c931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea000000006a473044022011dd49f90eb34195e61712cef41d16ce9496807124b1e1c6205cb06ccfdbef0002203b2553032d166724d89a42a12b997cb1c4a78c4d8bbc72f94ab9ef4c3db36d38412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffffc931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea010000006b483045022100f8a92d8e09a239d863b57c44fd2915558afbe05074c992b72639288f15a5a928022047399d49fcc7354140ecec229fe682383a9e9c59e43da368d35d211a06a17f2641210363d67968518ee1c0485b9b95544c0a9ec8c280b649b72c74fe86c299cd055a3bfeffffff250d555b731c8ba2843781d812f1aefbad643665864f29eef18f0b65b77ca9a7010000006b483045022100ece110a2ae06c67f3d4b25ad4ec2d7acf85fa1618dabef9d7eed5b4e5c50bbea02207716c2a9dd8d1ce64a56a3377eb35892db42dbba62058ebeb1b14ca33a8b98c241210241f2c990d7e0fe5c1c5e4508883b76b9786fcc67ccee1b8724eefa89a8f32981feffffff4713da1eacb49f37bd414205706229ddd8a85639a864c063fd2fd1a943ee1569010000006b483045022100831aac063f1b32f9e5645c5442a6b15cb620c6c49930f0194fa6acf6c864f48202203a8cc93d8bcd6f7d86cac0c7c99485cc1837fc87790f13f5bbf2f3b901e86be341210376c2519a09f7cfbcbe000f823c1e957cadace64296e907ae1ea36536313f0706feffffffcb551ea63f1903d74888a1f8989fb521df1567740a0edcf862fbd4f372783236010000006b483045022100f0fa4ab61952f5497d4dfe6b7a4e5e9b3305a5b94b0d7a6d1536927dfea2aa4202205eaa36045812bf5561c9e3a38fc92e6d89908637a5c0ec250a843f36355418c2412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff02bccdf505000000001976a914349256bff9dbe79285454d0e55d1a3163bd6dff888ac0084d717000000001976a914e2e4d329a79401e0a713210a4c615abdc540eda888ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9":
					return bt.NewTxFromString("02000000022082b13cb07c06d360773aca3ee9fe8bc5d73f8ad0e3698cc2e23e83bc2f3dc1000000006b483045022100a5c4b36223100189519957f41ae4ec345e4e2782f567d46504c4a432e523b34802203598789197f91e06a136e7dd16e163669de3b03123497f6d8a9a266be975a4df412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549010000006a473044022007a2fc274ace708d919fcd79ac134f8acf47a9ce6e10795e1c6a51548684ea9e022017cd7982c3b86bf874b3aaaa5324241b415fc4c299463b072074bdbac367ef8c412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a914863189af8516a85b2a12db0119540070c977a18288ac67000000")
				case "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25":
					return bt.NewTxFromString("0200000002fa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1010000006b483045022100c406943f8804eed1a4021d6f7b91c3f9b294b43b1bde8f221d395b503c312e390220351399f0ccafa9a469dd280317903168d2c4a0623440c828451711c8e4d9e24241210348ec9620f94ce08b6c422fc08e5156a4fa23229cdab9608065baf3a0ba33391bfeffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549000000006a4730440220658519a33702c58c6556be863f324b705cf7e6e8b7f255356351531d7064028002204c16dc99b12d7202f0e56a32408433425f48b67d22be9d491f843e51cb84c5fc4121020cbd8a7a8cac2f87a8e606061569e89488416af21967a2da635fe25ee157f5fdfeffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88acdad3f505000000001976a914e3e56e8e16fc7a694cdd585dac37a5c26dbae93688ac67000000")
				case "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347":
					return bt.NewTxFromString("02000000028c8200863359b5bb9fe8a9537529fb27f289081dc182aecca6eec67c9dc810ec000000006b48304502210093802a05a1ec6483711bb1e62388e3adfe2187dc87d61b153d1f86bc4bc3a2a0022044fae573bc835851d0989fca28d554fafdb5ae9e62c11a9029f3ed26f92723e0412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15fefffffffa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1000000006b4830450221008c9d8d17e80a350d5b6685bd71618a2ff23919e6f4f802b955578c25ffc9bcc2022066396b37d2c4437b222903af476cae129c9bc95e398713d3d1ee68ebe47991e3412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a9144f0de48ccfea5dd8b01a95ade7fbe69842c5755988ac67000000")
				case "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb":
					return nil, nil
				default:
					return nil, fmt.Errorf("txid %s not defined for test", txID)
				}
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"2a65d19f8d29ce53beb0f0e636a1d7b368d5c87b67cd3164277a7d29b66a636e": nil,
					"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9": {
						Index:  9,
						TxOrID: "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25": {
						Index:  10,
						TxOrID: "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347": {
						Index:  10,
						TxOrID: "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"1040bbc6a17d8f6ce78c99ee80139647ab946613645d0076c4f79a63f480b1a0",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb": {
						Index:  7,
						TxOrID: "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"c13d2fbc833ee2c28c69e3d08a3fd7c58bfee93eca3a7760d3067cb03cb18220",
							"87b322ba2397a30f22a91e256ec07e3654a410df2c69d03eb496d13b65c58329",
							"70ff03adf845a2b65ab5de530e6f42ab6dd42bd26d92077476bd66266f4635fb",
							"3ef5795dfb057a047eec84a2a46b2fab0bf23486b0c70fff6f977dcaed55dda2",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("could not find tx 36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb"),
		},
		"error when getting tx is handled": {
			tx: "0200000005c931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea000000006a473044022011dd49f90eb34195e61712cef41d16ce9496807124b1e1c6205cb06ccfdbef0002203b2553032d166724d89a42a12b997cb1c4a78c4d8bbc72f94ab9ef4c3db36d38412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffffc931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea010000006b483045022100f8a92d8e09a239d863b57c44fd2915558afbe05074c992b72639288f15a5a928022047399d49fcc7354140ecec229fe682383a9e9c59e43da368d35d211a06a17f2641210363d67968518ee1c0485b9b95544c0a9ec8c280b649b72c74fe86c299cd055a3bfeffffff250d555b731c8ba2843781d812f1aefbad643665864f29eef18f0b65b77ca9a7010000006b483045022100ece110a2ae06c67f3d4b25ad4ec2d7acf85fa1618dabef9d7eed5b4e5c50bbea02207716c2a9dd8d1ce64a56a3377eb35892db42dbba62058ebeb1b14ca33a8b98c241210241f2c990d7e0fe5c1c5e4508883b76b9786fcc67ccee1b8724eefa89a8f32981feffffff4713da1eacb49f37bd414205706229ddd8a85639a864c063fd2fd1a943ee1569010000006b483045022100831aac063f1b32f9e5645c5442a6b15cb620c6c49930f0194fa6acf6c864f48202203a8cc93d8bcd6f7d86cac0c7c99485cc1837fc87790f13f5bbf2f3b901e86be341210376c2519a09f7cfbcbe000f823c1e957cadace64296e907ae1ea36536313f0706feffffffcb551ea63f1903d74888a1f8989fb521df1567740a0edcf862fbd4f372783236010000006b483045022100f0fa4ab61952f5497d4dfe6b7a4e5e9b3305a5b94b0d7a6d1536927dfea2aa4202205eaa36045812bf5561c9e3a38fc92e6d89908637a5c0ec250a843f36355418c2412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff02bccdf505000000001976a914349256bff9dbe79285454d0e55d1a3163bd6dff888ac0084d717000000001976a914e2e4d329a79401e0a713210a4c615abdc540eda888ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9":
					return bt.NewTxFromString("02000000022082b13cb07c06d360773aca3ee9fe8bc5d73f8ad0e3698cc2e23e83bc2f3dc1000000006b483045022100a5c4b36223100189519957f41ae4ec345e4e2782f567d46504c4a432e523b34802203598789197f91e06a136e7dd16e163669de3b03123497f6d8a9a266be975a4df412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549010000006a473044022007a2fc274ace708d919fcd79ac134f8acf47a9ce6e10795e1c6a51548684ea9e022017cd7982c3b86bf874b3aaaa5324241b415fc4c299463b072074bdbac367ef8c412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a914863189af8516a85b2a12db0119540070c977a18288ac67000000")
				case "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25":
					return bt.NewTxFromString("0200000002fa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1010000006b483045022100c406943f8804eed1a4021d6f7b91c3f9b294b43b1bde8f221d395b503c312e390220351399f0ccafa9a469dd280317903168d2c4a0623440c828451711c8e4d9e24241210348ec9620f94ce08b6c422fc08e5156a4fa23229cdab9608065baf3a0ba33391bfeffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549000000006a4730440220658519a33702c58c6556be863f324b705cf7e6e8b7f255356351531d7064028002204c16dc99b12d7202f0e56a32408433425f48b67d22be9d491f843e51cb84c5fc4121020cbd8a7a8cac2f87a8e606061569e89488416af21967a2da635fe25ee157f5fdfeffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88acdad3f505000000001976a914e3e56e8e16fc7a694cdd585dac37a5c26dbae93688ac67000000")
				case "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347":
					return nil, errors.New("big bad error")
				default:
					return nil, fmt.Errorf("txid %s not defined for test", txID)
				}
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"2a65d19f8d29ce53beb0f0e636a1d7b368d5c87b67cd3164277a7d29b66a636e": nil,
					"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9": {
						Index:  9,
						TxOrID: "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25": {
						Index:  10,
						TxOrID: "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347": {
						Index:  10,
						TxOrID: "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"1040bbc6a17d8f6ce78c99ee80139647ab946613645d0076c4f79a63f480b1a0",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb": {
						Index:  7,
						TxOrID: "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"c13d2fbc833ee2c28c69e3d08a3fd7c58bfee93eca3a7760d3067cb03cb18220",
							"87b322ba2397a30f22a91e256ec07e3654a410df2c69d03eb496d13b65c58329",
							"70ff03adf845a2b65ab5de530e6f42ab6dd42bd26d92077476bd66266f4635fb",
							"3ef5795dfb057a047eec84a2a46b2fab0bf23486b0c70fff6f977dcaed55dda2",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("failed to get tx 6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347: big bad error"),
		},
		"error when getting merkle proof is handled": {
			tx: "0200000005c931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea000000006a473044022011dd49f90eb34195e61712cef41d16ce9496807124b1e1c6205cb06ccfdbef0002203b2553032d166724d89a42a12b997cb1c4a78c4d8bbc72f94ab9ef4c3db36d38412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffffc931fb0af1eedc1fcb1c00171c80fcdef48564d3a8582dd530a9ba258497b1ea010000006b483045022100f8a92d8e09a239d863b57c44fd2915558afbe05074c992b72639288f15a5a928022047399d49fcc7354140ecec229fe682383a9e9c59e43da368d35d211a06a17f2641210363d67968518ee1c0485b9b95544c0a9ec8c280b649b72c74fe86c299cd055a3bfeffffff250d555b731c8ba2843781d812f1aefbad643665864f29eef18f0b65b77ca9a7010000006b483045022100ece110a2ae06c67f3d4b25ad4ec2d7acf85fa1618dabef9d7eed5b4e5c50bbea02207716c2a9dd8d1ce64a56a3377eb35892db42dbba62058ebeb1b14ca33a8b98c241210241f2c990d7e0fe5c1c5e4508883b76b9786fcc67ccee1b8724eefa89a8f32981feffffff4713da1eacb49f37bd414205706229ddd8a85639a864c063fd2fd1a943ee1569010000006b483045022100831aac063f1b32f9e5645c5442a6b15cb620c6c49930f0194fa6acf6c864f48202203a8cc93d8bcd6f7d86cac0c7c99485cc1837fc87790f13f5bbf2f3b901e86be341210376c2519a09f7cfbcbe000f823c1e957cadace64296e907ae1ea36536313f0706feffffffcb551ea63f1903d74888a1f8989fb521df1567740a0edcf862fbd4f372783236010000006b483045022100f0fa4ab61952f5497d4dfe6b7a4e5e9b3305a5b94b0d7a6d1536927dfea2aa4202205eaa36045812bf5561c9e3a38fc92e6d89908637a5c0ec250a843f36355418c2412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff02bccdf505000000001976a914349256bff9dbe79285454d0e55d1a3163bd6dff888ac0084d717000000001976a914e2e4d329a79401e0a713210a4c615abdc540eda888ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9":
					return bt.NewTxFromString("02000000022082b13cb07c06d360773aca3ee9fe8bc5d73f8ad0e3698cc2e23e83bc2f3dc1000000006b483045022100a5c4b36223100189519957f41ae4ec345e4e2782f567d46504c4a432e523b34802203598789197f91e06a136e7dd16e163669de3b03123497f6d8a9a266be975a4df412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549010000006a473044022007a2fc274ace708d919fcd79ac134f8acf47a9ce6e10795e1c6a51548684ea9e022017cd7982c3b86bf874b3aaaa5324241b415fc4c299463b072074bdbac367ef8c412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a914863189af8516a85b2a12db0119540070c977a18288ac67000000")
				case "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25":
					return bt.NewTxFromString("0200000002fa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1010000006b483045022100c406943f8804eed1a4021d6f7b91c3f9b294b43b1bde8f221d395b503c312e390220351399f0ccafa9a469dd280317903168d2c4a0623440c828451711c8e4d9e24241210348ec9620f94ce08b6c422fc08e5156a4fa23229cdab9608065baf3a0ba33391bfeffffff4bcbb7ca743245103b7c31c75845acfbe7ecaa62b90728fd3d9d0da81b0f5549000000006a4730440220658519a33702c58c6556be863f324b705cf7e6e8b7f255356351531d7064028002204c16dc99b12d7202f0e56a32408433425f48b67d22be9d491f843e51cb84c5fc4121020cbd8a7a8cac2f87a8e606061569e89488416af21967a2da635fe25ee157f5fdfeffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88acdad3f505000000001976a914e3e56e8e16fc7a694cdd585dac37a5c26dbae93688ac67000000")
				case "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347":
					return bt.NewTxFromString("02000000028c8200863359b5bb9fe8a9537529fb27f289081dc182aecca6eec67c9dc810ec000000006b48304502210093802a05a1ec6483711bb1e62388e3adfe2187dc87d61b153d1f86bc4bc3a2a0022044fae573bc835851d0989fca28d554fafdb5ae9e62c11a9029f3ed26f92723e0412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15fefffffffa77c2cafc9d4e47792debdfbc812882fbdf7e5d08b9fa9751a7ee079be176a1000000006b4830450221008c9d8d17e80a350d5b6685bd71618a2ff23919e6f4f802b955578c25ffc9bcc2022066396b37d2c4437b222903af476cae129c9bc95e398713d3d1ee68ebe47991e3412103f6e8ebb2836f89aedbe712fa91eda827df597a01fe1a19fa1658bc1d28d1ad15feffffff0200e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac8adff505000000001976a9144f0de48ccfea5dd8b01a95ade7fbe69842c5755988ac67000000")
				case "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb":
					return bt.NewTxFromString("0200000001e65bf7813ee5bf1793a3487c2701f73b1b47f56fe7f7f36d7ee64b8987563f42000000004847304402206a9fe9ae02ecc95f8a90833707f9d04574618c6b9bb70ec67e5a16c1d04e08090220524fff062a60f03bf6560b392791b73982331f75e72afdd51a0b1d58d9bffe3e41feffffff0240101024010000001976a9144685874765a3e652d6869f5651d19000302275a888ac00e1f505000000001976a914b9be6c0240ce6137722a5ef28121d5967ce1049f88ac67000000")
				default:
					return nil, fmt.Errorf("txid %s not defined for test", txID)
				}
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				if txID == "a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25" {
					return nil, errors.New("bigger badder error")
				}
				mp, ok := map[string]*bc.MerkleProof{
					"2a65d19f8d29ce53beb0f0e636a1d7b368d5c87b67cd3164277a7d29b66a636e": nil,
					"eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9": {
						Index:  9,
						TxOrID: "eab1978425baa930d52d58a8d36485f4defc801c17001ccb1fdceef10afb31c9",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25",
							"8f0a05a7521bc16d51c2e8a665240d1e96990f17cdb83da4e5068f74e45880b2",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347": {
						Index:  10,
						TxOrID: "6915ee43a9d12ffd63c064a83956a8d8dd296270054241bd379fb4ac1eda1347",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"1040bbc6a17d8f6ce78c99ee80139647ab946613645d0076c4f79a63f480b1a0",
							"9d10f718525917a9c5bb3e52de7d3f0a3ab7a73fb8c93a63fb78b1f1eeca10bc",
							"5f57282b95ff1700473fada36c3451eb4e84c0db9fa79a038c0b7e1127d63aa3",
						},
					},
					"36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb": {
						Index:  7,
						TxOrID: "36327872f3d4fb62f8dc0e0a746715df21b59f98f8a18848d703193fa61e55cb",
						Target: "5e737154657f6283210e3d6b93adb4d5231859e93bea0ec18d9f60cb7a7c500a",
						Nodes: []string{
							"c13d2fbc833ee2c28c69e3d08a3fd7c58bfee93eca3a7760d3067cb03cb18220",
							"87b322ba2397a30f22a91e256ec07e3654a410df2c69d03eb496d13b65c58329",
							"70ff03adf845a2b65ab5de530e6f42ab6dd42bd26d92077476bd66266f4635fb",
							"3ef5795dfb057a047eec84a2a46b2fab0bf23486b0c70fff6f977dcaed55dda2",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("failed to get merkle proof for tx a7a97cb7650b8ff1ee294f86653664adfbaef112d8813784a28b1c735b550d25: bigger badder error"),
		},
		"envelope needing multiple layers can be built": {
			tx: "02000000054e5113bf8330981b4f063d95d18540bc09016843347437ace0133f27c830a518000000006a47304402204455d7f4e1ccf6c8aa47e7b99349e02aadc80474e3c8b9b479d2d5aa98eb954402206a3ac9cc086bb03cb4a9db872fbb46d682f1036dd5e51d910484d62651eaad124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a000000006b483045022100a0882e9db7ff299178211b7223ee891119d22374c8e2ce21aec00daaad5e170102207af1d17b4d9ed4f9684e520f709239fded50f3ea7d5ec7a9e458ab00a2efffea412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a010000006b483045022100b1d5b94ce9b5a1c8b531757aff4439bfb426dc439c3e35f6cdc3a08c9657ea0c02203c8490252d52db4557032042a5dcc8c3a2cdd9378dfd38f5ca03a9940ca055a2412103b05c23dcb06d192490d83c39bfbb515dfd0c0c172ae9314c91824b8936459132feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa010000006b483045022100bda388d23ccbea1beb3b1b55387600ae1b54759844beca4e9bcd405c2665b1a902206e536756978ffc3812c12f6eeeb82de351e13ad70d9e93c2358eb8a3c315330d4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff99995c0c19cda01cec64b7e20a3df37920bd3ad1ba6e666e337cb37d7829b354000000006a47304402205d6ebce84aeaf337c81894ffce89cc21a59a8659d07a599bb3371e5fee89153c02204432f8fae576e0aa47122d2dfbc914a6a34813fba86ecd0fcf0dd7ca65d199df4121034fc957d2e5b7299624148b914e830c763532983979c4cb3df29cca2751982d9afeffffff0282c3f505000000001976a9147fcac6c6eabf96ea58e561d3880f8e68bc58574088ac0027b929000000001976a9142d58ec9527c3df1ada4cac18cde85beb57cb199588ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e":
					return bt.NewTxFromString("0200000002703e994d4a81999de279c58d82f6aaa796bbba3d2da965fa99188067bf9d6606010000006b483045022100f1db569063675b18f1684db90294594931b82de72787878da2c9f628344d536102203efa439af8cc4725edb18c3f707a10ef9f5bb7dc46bd8ff35590312058f428274121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa000000006a4730440220023d6e7295e0e3e6aca2a56a9295e65dfb09f0e39b68ee81a10c13d24575414f022043cc1a6c1a7ce20a7b200ea26f77c590030a9400a55ca175ceef42471ba44227412102cf9a3a9e474debf4a369c6fcb01a630b0d137bc7044c559f49bedc5c12ee1440feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac78cff505000000001976a914e534d5ca3fb18b6b715840da7700da5957ffaa6d88ac65000000")
				case "0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53":
					return bt.NewTxFromString("0200000002e44dbadbb4b5e98bb8155a09617c1f2a49f7f8773d2f0c9c56a90fff236a9bbb010000006a473044022012c9007510bc1f2a1b3b40ccf1ab2692d67a96ee78c348a071478a7301ed0d9d02202c171744e28d72c2dbe190b5eabc86a5a7d65d688a0c200c04f0f1c66781c4d7412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f000000006a473044022004c6231dfd804174643ac91937499a610ce53fcc4c65bcd87269dc947b557bee0220237218a5f79e7b411fc2c1356eb8a3fef3d03254025b4281959ac9336e13fdf54121033a19ca01a45c1e8d887b20862957a53b15b1ef4274861be0c8da0dcdd579774dfeffffff020084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac2ac8f505000000001976a91465b9c7b5273c869d2e15da67fbd06cbee71853e488ac67000000")
				case "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd":
					return bt.NewTxFromString("0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000")
				case "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999":
					return bt.NewTxFromString("0200000002fbf8f324c2e831c72230e8ff1c592bce4dbcbf791bef9f476b19e95dcace16ec000000006b483045022100ec4fc37d25cc8cbf16bd5d0e0c3866c149cf5895b724cc9840be4b80394b6b480220146e8841a4481678f751ac25d8b78b79ca6b1e64c1312af09cca8f277719f0e4412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f010000006a4730440220561b0c6ec1ee171d1bd0bdc96d55a168394cbf9710bd7a37917a20166eed17ea02201c90e37d4a625b11664bde2732f19a7efb86098dc48e0e0ad2599689c392f4914121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff028adff505000000001976a9142e0b87094ca792266bd1861673c8488d785e92a288ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac67000000")
				case "06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70":
					return bt.NewTxFromString("02000000020b1ae1b8ddba43359db85256de9f352e6d8db29cddddcefd09141222d1f5588f000000006b48304502210094ca2714f58cb64c26ce406c3c65945fe8ee74fdd3b63324209d7ca15c248d520220106488d6ec20ed368eeae9aca77bfdbc9aefab36067ef014d733d3b464b95ab34121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c010000006b48304502210087a2ddeb5445da184e2475eb644f44465b3815f1f5749d9f3d5d91fa2a6eae7302204d02ead4f59b5bc4b781d94011502c69cc542c54b60456a6524f0c2db1d86c724121034957874f61665ca808bd47a1ad9e44aaeb993bd2466de73841e941c226b68206feffffff0228dbf505000000001976a9145b030de4b3883b6fd75ab485620208b22d8a6b2488ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73":
					return bt.NewTxFromString("020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915":
					return bt.NewTxFromString("0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000")
				case "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900":
					return bt.NewTxFromString("02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000")
				case "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15":
					return bt.NewTxFromString("020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4":
					return bt.NewTxFromString("0200000001742ee0a5307c56206abd6ec38026264ae67ac8475f7b7ce0cff8bccce15096f40000000049483045022100abc541d0ffa5157c7376204fec2ad89cf4c22c173dd292b1bb4ef6dadcd0fb2702203f2794a04d1a161a1d17bc4d2df7fe09c04c7fcd9b1b966e4cec324fd134ff0f41feffffff02406d2e12010000001976a914eb0db95d9be7c1489d7a6cbbfdff4eeb2a403d2988ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac35000000")
				case "8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965":
					return bt.NewTxFromString("02000000028e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8000000006a47304402206860d587a40b472700f8397334ce6eb8a38769deae72b5a35d51b3fc653ac7db02205490ff34104abe5578629890fa105f004b9fcfa5e6a140e3d934eb61dc7e255a4121029c51e53cea955bc43972d3718750deed8995420bf3f7f437e5ac0a364e58e5b8feffffff8e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8010000006b483045022100e5d2e2934c6c0a2591809f5da4f41f82e0c7f254829a7f8bc4d4176c254f9cea022040cf9a0bde5e7bf91c8bd4431463e2d6be199d5039611469abf374c28caa01124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02a0c9f505000000001976a9144cf46ab01b157ffece20bbeaa84d5d1822624f8088ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e":
					return bt.NewTxFromString("020000000238790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72000000006a47304402202681f4bf3620bb2fc538212ca8e51911c24085567f905ae86dd2d8c1131d84cc022023f59800ba85c5e006cd0908176528e39ce336326d8f2161189a9ac7c7d6b9124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff38790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72010000006a47304402203ce2f5fec7aa340f12577a38ee1192b8096f384f7b02ed2640f73f6ac06aaefe02202ae0650d3ff7a0c7442ea43dd0257844c0be30458a84e7796a948f21a6ff0106412103c21ad3a4808ac02b1038281dc2e336a1892bdba484b82dfa6efbb073aeea0c6efeffffff0216cbf505000000001976a914f5fa8c0dc33e58d73f05cd97a83bf0967b44de7788ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b":
					return bt.NewTxFromString("020000000100e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64010000006a473044022031773c6d77faef9e23650f563cb15dc2be9d666a4b8a55361c8a17ae8bbe8a930220174665e8ff0d908980bcc582d893c7b40f07192d953e9ac047efc655bf9f9ebd412102ece1c130472e24f8e4c10addc603d7e16f53d37a717eb51078f0f257549b406dfeffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9a6a2e12010000001976a914eb3766cc050cf8e77a090f307b37b3b541354dfa88ac65000000")
				case "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754":
					return bt.NewTxFromString("020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000")
				}
				return nil, fmt.Errorf("tx %s not defined for test", txID)
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e": nil,
					"06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70": nil,
					"8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b": nil,
					"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": nil,
					"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": nil,
					"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": nil,
					"0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53": nil,
					"8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965": nil,
					"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
						Index:  13,
						TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
							"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
							"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
							"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
						Index:  5,
						TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
						Index:  4,
						TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4": {
						Index:  2,
						TxOrID: "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
						Target: "6a1573df44b5d65476a83ea0759a0726718b9803a700cce3ce1b60fa82ca2b33",
						Nodes: []string{
							"*",
							"627d052fdc77119f37a5757f029a095d10e165450341dc9e389d371257661c1a",
						},
					},
					"a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e": {
						Index:  19,
						TxOrID: "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"72ad1b2bd8dc0271b2ebc2188703d2826114ddfe3fabeb4637694475fd0e7938",
							"7ac7acab28a58b221a0272e70c7c10d8940358fd3ef7a6ac5b8fe5360ceaf071",
							"133c6e7635258f852ab4c8642745a39c5e5ca1a58f28645ce78168a5c81ede10",
							"4a53fdd1d306f1b42d70ed8e9720c903e40b8dbea99c46b366ba8021cecd9524",
							"57e93b9909f03a1f46143f0bf107f4cecb4e6dd7d4de7c7f44cd0a3332ea73a4",
						},
					},
					"54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999": {
						Index:  2,
						TxOrID: "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
						Target: "58539b1244cb52341774fe4285b85d7f28a8022a20c47c014723b1d7992059dd",
						Nodes: []string{
							"*",
							"79aec2d96ccb20764518154a96bda4903cc7f72a8eea14331318d3d53dfcc75e",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			exp: spv.Envelope{
				TxID:  "b71967010b37ba8646b82ec4a23ebf6406bee23aee2b6cec9fd67d922c634b50",
				RawTx: "02000000054e5113bf8330981b4f063d95d18540bc09016843347437ace0133f27c830a518000000006a47304402204455d7f4e1ccf6c8aa47e7b99349e02aadc80474e3c8b9b479d2d5aa98eb954402206a3ac9cc086bb03cb4a9db872fbb46d682f1036dd5e51d910484d62651eaad124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a000000006b483045022100a0882e9db7ff299178211b7223ee891119d22374c8e2ce21aec00daaad5e170102207af1d17b4d9ed4f9684e520f709239fded50f3ea7d5ec7a9e458ab00a2efffea412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a010000006b483045022100b1d5b94ce9b5a1c8b531757aff4439bfb426dc439c3e35f6cdc3a08c9657ea0c02203c8490252d52db4557032042a5dcc8c3a2cdd9378dfd38f5ca03a9940ca055a2412103b05c23dcb06d192490d83c39bfbb515dfd0c0c172ae9314c91824b8936459132feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa010000006b483045022100bda388d23ccbea1beb3b1b55387600ae1b54759844beca4e9bcd405c2665b1a902206e536756978ffc3812c12f6eeeb82de351e13ad70d9e93c2358eb8a3c315330d4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff99995c0c19cda01cec64b7e20a3df37920bd3ad1ba6e666e337cb37d7829b354000000006a47304402205d6ebce84aeaf337c81894ffce89cc21a59a8659d07a599bb3371e5fee89153c02204432f8fae576e0aa47122d2dfbc914a6a34813fba86ecd0fcf0dd7ca65d199df4121034fc957d2e5b7299624148b914e830c763532983979c4cb3df29cca2751982d9afeffffff0282c3f505000000001976a9147fcac6c6eabf96ea58e561d3880f8e68bc58574088ac0027b929000000001976a9142d58ec9527c3df1ada4cac18cde85beb57cb199588ac68000000",
				Parents: map[string]*spv.Envelope{
					"18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e": {
						TxID:  "18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e",
						RawTx: "0200000002703e994d4a81999de279c58d82f6aaa796bbba3d2da965fa99188067bf9d6606010000006b483045022100f1db569063675b18f1684db90294594931b82de72787878da2c9f628344d536102203efa439af8cc4725edb18c3f707a10ef9f5bb7dc46bd8ff35590312058f428274121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa000000006a4730440220023d6e7295e0e3e6aca2a56a9295e65dfb09f0e39b68ee81a10c13d24575414f022043cc1a6c1a7ce20a7b200ea26f77c590030a9400a55ca175ceef42471ba44227412102cf9a3a9e474debf4a369c6fcb01a630b0d137bc7044c559f49bedc5c12ee1440feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac78cff505000000001976a914e534d5ca3fb18b6b715840da7700da5957ffaa6d88ac65000000",
						Parents: map[string]*spv.Envelope{
							"06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70": {
								TxID:  "06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70",
								RawTx: "02000000020b1ae1b8ddba43359db85256de9f352e6d8db29cddddcefd09141222d1f5588f000000006b48304502210094ca2714f58cb64c26ce406c3c65945fe8ee74fdd3b63324209d7ca15c248d520220106488d6ec20ed368eeae9aca77bfdbc9aefab36067ef014d733d3b464b95ab34121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c010000006b48304502210087a2ddeb5445da184e2475eb644f44465b3815f1f5749d9f3d5d91fa2a6eae7302204d02ead4f59b5bc4b781d94011502c69cc542c54b60456a6524f0c2db1d86c724121034957874f61665ca808bd47a1ad9e44aaeb993bd2466de73841e941c226b68206feffffff0228dbf505000000001976a9145b030de4b3883b6fd75ab485620208b22d8a6b2488ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
								Parents: map[string]*spv.Envelope{
									"8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b": {
										TxID:  "8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b",
										RawTx: "020000000100e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64010000006a473044022031773c6d77faef9e23650f563cb15dc2be9d666a4b8a55361c8a17ae8bbe8a930220174665e8ff0d908980bcc582d893c7b40f07192d953e9ac047efc655bf9f9ebd412102ece1c130472e24f8e4c10addc603d7e16f53d37a717eb51078f0f257549b406dfeffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9a6a2e12010000001976a914eb3766cc050cf8e77a090f307b37b3b541354dfa88ac65000000",
										Parents: map[string]*spv.Envelope{
											"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
												TxID:  "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
												RawTx: "02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000",
												Proof: &bc.MerkleProof{
													Index:  5,
													TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
														"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
														"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
														"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
										},
									},
									"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": {
										TxID:  "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754",
										RawTx: "020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000",
										Parents: map[string]*spv.Envelope{
											"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
												TxID:  "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
												RawTx: "02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000",
												Proof: &bc.MerkleProof{
													Index:  5,
													TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
														"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
														"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
														"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
											"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
												TxID:  "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
												RawTx: "020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
												Proof: &bc.MerkleProof{
													Index:  4,
													TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
														"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
														"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
														"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
										},
									},
								},
							},
							"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": {
								TxID:  "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd",
								RawTx: "0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000",
								Parents: map[string]*spv.Envelope{
									"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": {
										TxID:  "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73",
										RawTx: "020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
										Parents: map[string]*spv.Envelope{
											"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
												TxID:  "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
												RawTx: "0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000",
												Proof: &bc.MerkleProof{
													Index:  13,
													TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
														"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
														"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
														"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
										},
									},
									"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": {
										TxID:  "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754",
										RawTx: "020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000",
										Parents: map[string]*spv.Envelope{
											"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
												TxID:  "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
												RawTx: "02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000",
												Proof: &bc.MerkleProof{
													Index:  5,
													TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
														"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
														"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
														"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
											"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
												TxID:  "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
												RawTx: "020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
												Proof: &bc.MerkleProof{
													Index:  4,
													TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
													Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
													Nodes: []string{
														"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
														"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
														"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
														"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
														"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
													},
												},
											},
										},
									},
								},
							},
						},
					},
					"0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53": {
						TxID:  "0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53",
						RawTx: "0200000002e44dbadbb4b5e98bb8155a09617c1f2a49f7f8773d2f0c9c56a90fff236a9bbb010000006a473044022012c9007510bc1f2a1b3b40ccf1ab2692d67a96ee78c348a071478a7301ed0d9d02202c171744e28d72c2dbe190b5eabc86a5a7d65d688a0c200c04f0f1c66781c4d7412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f000000006a473044022004c6231dfd804174643ac91937499a610ce53fcc4c65bcd87269dc947b557bee0220237218a5f79e7b411fc2c1356eb8a3fef3d03254025b4281959ac9336e13fdf54121033a19ca01a45c1e8d887b20862957a53b15b1ef4274861be0c8da0dcdd579774dfeffffff020084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac2ac8f505000000001976a91465b9c7b5273c869d2e15da67fbd06cbee71853e488ac67000000",
						Parents: map[string]*spv.Envelope{
							"bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4": {
								TxID:  "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
								RawTx: "0200000001742ee0a5307c56206abd6ec38026264ae67ac8475f7b7ce0cff8bccce15096f40000000049483045022100abc541d0ffa5157c7376204fec2ad89cf4c22c173dd292b1bb4ef6dadcd0fb2702203f2794a04d1a161a1d17bc4d2df7fe09c04c7fcd9b1b966e4cec324fd134ff0f41feffffff02406d2e12010000001976a914eb0db95d9be7c1489d7a6cbbfdff4eeb2a403d2988ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac35000000",
								Proof: &bc.MerkleProof{
									Index:  2,
									TxOrID: "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
									Target: "6a1573df44b5d65476a83ea0759a0726718b9803a700cce3ce1b60fa82ca2b33",
									Nodes: []string{
										"*",
										"627d052fdc77119f37a5757f029a095d10e165450341dc9e389d371257661c1a",
									},
								},
							},
							"8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965": {
								TxID:  "8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965",
								RawTx: "02000000028e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8000000006a47304402206860d587a40b472700f8397334ce6eb8a38769deae72b5a35d51b3fc653ac7db02205490ff34104abe5578629890fa105f004b9fcfa5e6a140e3d934eb61dc7e255a4121029c51e53cea955bc43972d3718750deed8995420bf3f7f437e5ac0a364e58e5b8feffffff8e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8010000006b483045022100e5d2e2934c6c0a2591809f5da4f41f82e0c7f254829a7f8bc4d4176c254f9cea022040cf9a0bde5e7bf91c8bd4431463e2d6be199d5039611469abf374c28caa01124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02a0c9f505000000001976a9144cf46ab01b157ffece20bbeaa84d5d1822624f8088ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
								Parents: map[string]*spv.Envelope{
									"a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e": {
										TxID:  "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
										RawTx: "020000000238790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72000000006a47304402202681f4bf3620bb2fc538212ca8e51911c24085567f905ae86dd2d8c1131d84cc022023f59800ba85c5e006cd0908176528e39ce336326d8f2161189a9ac7c7d6b9124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff38790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72010000006a47304402203ce2f5fec7aa340f12577a38ee1192b8096f384f7b02ed2640f73f6ac06aaefe02202ae0650d3ff7a0c7442ea43dd0257844c0be30458a84e7796a948f21a6ff0106412103c21ad3a4808ac02b1038281dc2e336a1892bdba484b82dfa6efbb073aeea0c6efeffffff0216cbf505000000001976a914f5fa8c0dc33e58d73f05cd97a83bf0967b44de7788ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
										Proof: &bc.MerkleProof{
											Index:  19,
											TxOrID: "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
											Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
											Nodes: []string{
												"72ad1b2bd8dc0271b2ebc2188703d2826114ddfe3fabeb4637694475fd0e7938",
												"7ac7acab28a58b221a0272e70c7c10d8940358fd3ef7a6ac5b8fe5360ceaf071",
												"133c6e7635258f852ab4c8642745a39c5e5ca1a58f28645ce78168a5c81ede10",
												"4a53fdd1d306f1b42d70ed8e9720c903e40b8dbea99c46b366ba8021cecd9524",
												"57e93b9909f03a1f46143f0bf107f4cecb4e6dd7d4de7c7f44cd0a3332ea73a4",
											},
										},
									},
								},
							},
						},
					},
					"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": {
						TxID:  "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd",
						RawTx: "0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000",
						Parents: map[string]*spv.Envelope{
							"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": {
								TxID:  "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73",
								RawTx: "020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
								Parents: map[string]*spv.Envelope{
									"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
										TxID:  "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
										RawTx: "0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000",
										Proof: &bc.MerkleProof{
											Index:  13,
											TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
											Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
											Nodes: []string{
												"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
												"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
												"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
												"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
												"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
											},
										},
									},
								},
							},
							"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": {
								TxID:  "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754",
								RawTx: "020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000",
								Parents: map[string]*spv.Envelope{
									"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
										TxID:  "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
										RawTx: "02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000",
										Proof: &bc.MerkleProof{
											Index:  5,
											TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
											Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
											Nodes: []string{
												"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
												"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
												"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
												"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
												"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
											},
										},
									},
									"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
										TxID:  "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
										RawTx: "020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000",
										Proof: &bc.MerkleProof{
											Index:  4,
											TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
											Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
											Nodes: []string{
												"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
												"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
												"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
												"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
												"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
											},
										},
									},
								},
							},
						},
					},
					"54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999": {
						TxID:  "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
						RawTx: "0200000002fbf8f324c2e831c72230e8ff1c592bce4dbcbf791bef9f476b19e95dcace16ec000000006b483045022100ec4fc37d25cc8cbf16bd5d0e0c3866c149cf5895b724cc9840be4b80394b6b480220146e8841a4481678f751ac25d8b78b79ca6b1e64c1312af09cca8f277719f0e4412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f010000006a4730440220561b0c6ec1ee171d1bd0bdc96d55a168394cbf9710bd7a37917a20166eed17ea02201c90e37d4a625b11664bde2732f19a7efb86098dc48e0e0ad2599689c392f4914121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff028adff505000000001976a9142e0b87094ca792266bd1861673c8488d785e92a288ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac67000000",
						Proof: &bc.MerkleProof{
							Index:  2,
							TxOrID: "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
							Target: "58539b1244cb52341774fe4285b85d7f28a8022a20c47c014723b1d7992059dd",
							Nodes: []string{
								"*",
								"79aec2d96ccb20764518154a96bda4903cc7f72a8eea14331318d3d53dfcc75e",
							},
						},
					},
				},
			},
		},
		"missing tx multiple layers down causes error": {
			tx: "02000000054e5113bf8330981b4f063d95d18540bc09016843347437ace0133f27c830a518000000006a47304402204455d7f4e1ccf6c8aa47e7b99349e02aadc80474e3c8b9b479d2d5aa98eb954402206a3ac9cc086bb03cb4a9db872fbb46d682f1036dd5e51d910484d62651eaad124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a000000006b483045022100a0882e9db7ff299178211b7223ee891119d22374c8e2ce21aec00daaad5e170102207af1d17b4d9ed4f9684e520f709239fded50f3ea7d5ec7a9e458ab00a2efffea412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a010000006b483045022100b1d5b94ce9b5a1c8b531757aff4439bfb426dc439c3e35f6cdc3a08c9657ea0c02203c8490252d52db4557032042a5dcc8c3a2cdd9378dfd38f5ca03a9940ca055a2412103b05c23dcb06d192490d83c39bfbb515dfd0c0c172ae9314c91824b8936459132feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa010000006b483045022100bda388d23ccbea1beb3b1b55387600ae1b54759844beca4e9bcd405c2665b1a902206e536756978ffc3812c12f6eeeb82de351e13ad70d9e93c2358eb8a3c315330d4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff99995c0c19cda01cec64b7e20a3df37920bd3ad1ba6e666e337cb37d7829b354000000006a47304402205d6ebce84aeaf337c81894ffce89cc21a59a8659d07a599bb3371e5fee89153c02204432f8fae576e0aa47122d2dfbc914a6a34813fba86ecd0fcf0dd7ca65d199df4121034fc957d2e5b7299624148b914e830c763532983979c4cb3df29cca2751982d9afeffffff0282c3f505000000001976a9147fcac6c6eabf96ea58e561d3880f8e68bc58574088ac0027b929000000001976a9142d58ec9527c3df1ada4cac18cde85beb57cb199588ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e":
					return bt.NewTxFromString("0200000002703e994d4a81999de279c58d82f6aaa796bbba3d2da965fa99188067bf9d6606010000006b483045022100f1db569063675b18f1684db90294594931b82de72787878da2c9f628344d536102203efa439af8cc4725edb18c3f707a10ef9f5bb7dc46bd8ff35590312058f428274121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa000000006a4730440220023d6e7295e0e3e6aca2a56a9295e65dfb09f0e39b68ee81a10c13d24575414f022043cc1a6c1a7ce20a7b200ea26f77c590030a9400a55ca175ceef42471ba44227412102cf9a3a9e474debf4a369c6fcb01a630b0d137bc7044c559f49bedc5c12ee1440feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac78cff505000000001976a914e534d5ca3fb18b6b715840da7700da5957ffaa6d88ac65000000")
				case "0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53":
					return bt.NewTxFromString("0200000002e44dbadbb4b5e98bb8155a09617c1f2a49f7f8773d2f0c9c56a90fff236a9bbb010000006a473044022012c9007510bc1f2a1b3b40ccf1ab2692d67a96ee78c348a071478a7301ed0d9d02202c171744e28d72c2dbe190b5eabc86a5a7d65d688a0c200c04f0f1c66781c4d7412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f000000006a473044022004c6231dfd804174643ac91937499a610ce53fcc4c65bcd87269dc947b557bee0220237218a5f79e7b411fc2c1356eb8a3fef3d03254025b4281959ac9336e13fdf54121033a19ca01a45c1e8d887b20862957a53b15b1ef4274861be0c8da0dcdd579774dfeffffff020084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac2ac8f505000000001976a91465b9c7b5273c869d2e15da67fbd06cbee71853e488ac67000000")
				case "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd":
					return bt.NewTxFromString("0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000")
				case "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999":
					return bt.NewTxFromString("0200000002fbf8f324c2e831c72230e8ff1c592bce4dbcbf791bef9f476b19e95dcace16ec000000006b483045022100ec4fc37d25cc8cbf16bd5d0e0c3866c149cf5895b724cc9840be4b80394b6b480220146e8841a4481678f751ac25d8b78b79ca6b1e64c1312af09cca8f277719f0e4412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f010000006a4730440220561b0c6ec1ee171d1bd0bdc96d55a168394cbf9710bd7a37917a20166eed17ea02201c90e37d4a625b11664bde2732f19a7efb86098dc48e0e0ad2599689c392f4914121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff028adff505000000001976a9142e0b87094ca792266bd1861673c8488d785e92a288ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac67000000")
				case "06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70":
					return bt.NewTxFromString("02000000020b1ae1b8ddba43359db85256de9f352e6d8db29cddddcefd09141222d1f5588f000000006b48304502210094ca2714f58cb64c26ce406c3c65945fe8ee74fdd3b63324209d7ca15c248d520220106488d6ec20ed368eeae9aca77bfdbc9aefab36067ef014d733d3b464b95ab34121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c010000006b48304502210087a2ddeb5445da184e2475eb644f44465b3815f1f5749d9f3d5d91fa2a6eae7302204d02ead4f59b5bc4b781d94011502c69cc542c54b60456a6524f0c2db1d86c724121034957874f61665ca808bd47a1ad9e44aaeb993bd2466de73841e941c226b68206feffffff0228dbf505000000001976a9145b030de4b3883b6fd75ab485620208b22d8a6b2488ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73":
					return bt.NewTxFromString("020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915":
					return bt.NewTxFromString("0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000")
				case "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900":
					return bt.NewTxFromString("02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000")
				case "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15":
					return bt.NewTxFromString("020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4":
					return bt.NewTxFromString("0200000001742ee0a5307c56206abd6ec38026264ae67ac8475f7b7ce0cff8bccce15096f40000000049483045022100abc541d0ffa5157c7376204fec2ad89cf4c22c173dd292b1bb4ef6dadcd0fb2702203f2794a04d1a161a1d17bc4d2df7fe09c04c7fcd9b1b966e4cec324fd134ff0f41feffffff02406d2e12010000001976a914eb0db95d9be7c1489d7a6cbbfdff4eeb2a403d2988ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac35000000")
				case "8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965":
					return bt.NewTxFromString("02000000028e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8000000006a47304402206860d587a40b472700f8397334ce6eb8a38769deae72b5a35d51b3fc653ac7db02205490ff34104abe5578629890fa105f004b9fcfa5e6a140e3d934eb61dc7e255a4121029c51e53cea955bc43972d3718750deed8995420bf3f7f437e5ac0a364e58e5b8feffffff8e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8010000006b483045022100e5d2e2934c6c0a2591809f5da4f41f82e0c7f254829a7f8bc4d4176c254f9cea022040cf9a0bde5e7bf91c8bd4431463e2d6be199d5039611469abf374c28caa01124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02a0c9f505000000001976a9144cf46ab01b157ffece20bbeaa84d5d1822624f8088ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e":
					return nil, nil
				case "8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b":
					return bt.NewTxFromString("020000000100e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64010000006a473044022031773c6d77faef9e23650f563cb15dc2be9d666a4b8a55361c8a17ae8bbe8a930220174665e8ff0d908980bcc582d893c7b40f07192d953e9ac047efc655bf9f9ebd412102ece1c130472e24f8e4c10addc603d7e16f53d37a717eb51078f0f257549b406dfeffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9a6a2e12010000001976a914eb3766cc050cf8e77a090f307b37b3b541354dfa88ac65000000")
				case "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754":
					return bt.NewTxFromString("020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000")
				}
				return nil, fmt.Errorf("tx %s not defined for test", txID)
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e": nil,
					"06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70": nil,
					"8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b": nil,
					"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": nil,
					"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": nil,
					"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": nil,
					"0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53": nil,
					"8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965": nil,
					"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
						Index:  13,
						TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
							"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
							"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
							"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
						Index:  5,
						TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
						Index:  4,
						TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4": {
						Index:  2,
						TxOrID: "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
						Target: "6a1573df44b5d65476a83ea0759a0726718b9803a700cce3ce1b60fa82ca2b33",
						Nodes: []string{
							"*",
							"627d052fdc77119f37a5757f029a095d10e165450341dc9e389d371257661c1a",
						},
					},
					"a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e": {
						Index:  19,
						TxOrID: "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"72ad1b2bd8dc0271b2ebc2188703d2826114ddfe3fabeb4637694475fd0e7938",
							"7ac7acab28a58b221a0272e70c7c10d8940358fd3ef7a6ac5b8fe5360ceaf071",
							"133c6e7635258f852ab4c8642745a39c5e5ca1a58f28645ce78168a5c81ede10",
							"4a53fdd1d306f1b42d70ed8e9720c903e40b8dbea99c46b366ba8021cecd9524",
							"57e93b9909f03a1f46143f0bf107f4cecb4e6dd7d4de7c7f44cd0a3332ea73a4",
						},
					},
					"54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999": {
						Index:  2,
						TxOrID: "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
						Target: "58539b1244cb52341774fe4285b85d7f28a8022a20c47c014723b1d7992059dd",
						Nodes: []string{
							"*",
							"79aec2d96ccb20764518154a96bda4903cc7f72a8eea14331318d3d53dfcc75e",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("could not find tx a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e"),
		},
		"error getting tx multiple layers down is handled": {
			tx: "02000000054e5113bf8330981b4f063d95d18540bc09016843347437ace0133f27c830a518000000006a47304402204455d7f4e1ccf6c8aa47e7b99349e02aadc80474e3c8b9b479d2d5aa98eb954402206a3ac9cc086bb03cb4a9db872fbb46d682f1036dd5e51d910484d62651eaad124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a000000006b483045022100a0882e9db7ff299178211b7223ee891119d22374c8e2ce21aec00daaad5e170102207af1d17b4d9ed4f9684e520f709239fded50f3ea7d5ec7a9e458ab00a2efffea412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a010000006b483045022100b1d5b94ce9b5a1c8b531757aff4439bfb426dc439c3e35f6cdc3a08c9657ea0c02203c8490252d52db4557032042a5dcc8c3a2cdd9378dfd38f5ca03a9940ca055a2412103b05c23dcb06d192490d83c39bfbb515dfd0c0c172ae9314c91824b8936459132feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa010000006b483045022100bda388d23ccbea1beb3b1b55387600ae1b54759844beca4e9bcd405c2665b1a902206e536756978ffc3812c12f6eeeb82de351e13ad70d9e93c2358eb8a3c315330d4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff99995c0c19cda01cec64b7e20a3df37920bd3ad1ba6e666e337cb37d7829b354000000006a47304402205d6ebce84aeaf337c81894ffce89cc21a59a8659d07a599bb3371e5fee89153c02204432f8fae576e0aa47122d2dfbc914a6a34813fba86ecd0fcf0dd7ca65d199df4121034fc957d2e5b7299624148b914e830c763532983979c4cb3df29cca2751982d9afeffffff0282c3f505000000001976a9147fcac6c6eabf96ea58e561d3880f8e68bc58574088ac0027b929000000001976a9142d58ec9527c3df1ada4cac18cde85beb57cb199588ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e":
					return bt.NewTxFromString("0200000002703e994d4a81999de279c58d82f6aaa796bbba3d2da965fa99188067bf9d6606010000006b483045022100f1db569063675b18f1684db90294594931b82de72787878da2c9f628344d536102203efa439af8cc4725edb18c3f707a10ef9f5bb7dc46bd8ff35590312058f428274121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa000000006a4730440220023d6e7295e0e3e6aca2a56a9295e65dfb09f0e39b68ee81a10c13d24575414f022043cc1a6c1a7ce20a7b200ea26f77c590030a9400a55ca175ceef42471ba44227412102cf9a3a9e474debf4a369c6fcb01a630b0d137bc7044c559f49bedc5c12ee1440feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac78cff505000000001976a914e534d5ca3fb18b6b715840da7700da5957ffaa6d88ac65000000")
				case "0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53":
					return bt.NewTxFromString("0200000002e44dbadbb4b5e98bb8155a09617c1f2a49f7f8773d2f0c9c56a90fff236a9bbb010000006a473044022012c9007510bc1f2a1b3b40ccf1ab2692d67a96ee78c348a071478a7301ed0d9d02202c171744e28d72c2dbe190b5eabc86a5a7d65d688a0c200c04f0f1c66781c4d7412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f000000006a473044022004c6231dfd804174643ac91937499a610ce53fcc4c65bcd87269dc947b557bee0220237218a5f79e7b411fc2c1356eb8a3fef3d03254025b4281959ac9336e13fdf54121033a19ca01a45c1e8d887b20862957a53b15b1ef4274861be0c8da0dcdd579774dfeffffff020084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac2ac8f505000000001976a91465b9c7b5273c869d2e15da67fbd06cbee71853e488ac67000000")
				case "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd":
					return bt.NewTxFromString("0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000")
				case "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999":
					return bt.NewTxFromString("0200000002fbf8f324c2e831c72230e8ff1c592bce4dbcbf791bef9f476b19e95dcace16ec000000006b483045022100ec4fc37d25cc8cbf16bd5d0e0c3866c149cf5895b724cc9840be4b80394b6b480220146e8841a4481678f751ac25d8b78b79ca6b1e64c1312af09cca8f277719f0e4412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f010000006a4730440220561b0c6ec1ee171d1bd0bdc96d55a168394cbf9710bd7a37917a20166eed17ea02201c90e37d4a625b11664bde2732f19a7efb86098dc48e0e0ad2599689c392f4914121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff028adff505000000001976a9142e0b87094ca792266bd1861673c8488d785e92a288ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac67000000")
				case "06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70":
					return bt.NewTxFromString("02000000020b1ae1b8ddba43359db85256de9f352e6d8db29cddddcefd09141222d1f5588f000000006b48304502210094ca2714f58cb64c26ce406c3c65945fe8ee74fdd3b63324209d7ca15c248d520220106488d6ec20ed368eeae9aca77bfdbc9aefab36067ef014d733d3b464b95ab34121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c010000006b48304502210087a2ddeb5445da184e2475eb644f44465b3815f1f5749d9f3d5d91fa2a6eae7302204d02ead4f59b5bc4b781d94011502c69cc542c54b60456a6524f0c2db1d86c724121034957874f61665ca808bd47a1ad9e44aaeb993bd2466de73841e941c226b68206feffffff0228dbf505000000001976a9145b030de4b3883b6fd75ab485620208b22d8a6b2488ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73":
					return bt.NewTxFromString("020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915":
					return bt.NewTxFromString("0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000")
				case "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900":
					return bt.NewTxFromString("02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000")
				case "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15":
					return bt.NewTxFromString("020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4":
					return bt.NewTxFromString("0200000001742ee0a5307c56206abd6ec38026264ae67ac8475f7b7ce0cff8bccce15096f40000000049483045022100abc541d0ffa5157c7376204fec2ad89cf4c22c173dd292b1bb4ef6dadcd0fb2702203f2794a04d1a161a1d17bc4d2df7fe09c04c7fcd9b1b966e4cec324fd134ff0f41feffffff02406d2e12010000001976a914eb0db95d9be7c1489d7a6cbbfdff4eeb2a403d2988ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac35000000")
				case "8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965":
					return nil, errors.New("close but no cigar")
				case "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e":
					return bt.NewTxFromString("020000000238790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72000000006a47304402202681f4bf3620bb2fc538212ca8e51911c24085567f905ae86dd2d8c1131d84cc022023f59800ba85c5e006cd0908176528e39ce336326d8f2161189a9ac7c7d6b9124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff38790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72010000006a47304402203ce2f5fec7aa340f12577a38ee1192b8096f384f7b02ed2640f73f6ac06aaefe02202ae0650d3ff7a0c7442ea43dd0257844c0be30458a84e7796a948f21a6ff0106412103c21ad3a4808ac02b1038281dc2e336a1892bdba484b82dfa6efbb073aeea0c6efeffffff0216cbf505000000001976a914f5fa8c0dc33e58d73f05cd97a83bf0967b44de7788ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b":
					return bt.NewTxFromString("020000000100e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64010000006a473044022031773c6d77faef9e23650f563cb15dc2be9d666a4b8a55361c8a17ae8bbe8a930220174665e8ff0d908980bcc582d893c7b40f07192d953e9ac047efc655bf9f9ebd412102ece1c130472e24f8e4c10addc603d7e16f53d37a717eb51078f0f257549b406dfeffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9a6a2e12010000001976a914eb3766cc050cf8e77a090f307b37b3b541354dfa88ac65000000")
				case "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754":
					return bt.NewTxFromString("020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000")
				}
				return nil, fmt.Errorf("tx %s not defined for test", txID)
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				mp, ok := map[string]*bc.MerkleProof{
					"18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e": nil,
					"06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70": nil,
					"8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b": nil,
					"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": nil,
					"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": nil,
					"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": nil,
					"0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53": nil,
					"8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965": nil,
					"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
						Index:  13,
						TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
							"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
							"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
							"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
						Index:  5,
						TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15": {
						Index:  4,
						TxOrID: "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4": {
						Index:  2,
						TxOrID: "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
						Target: "6a1573df44b5d65476a83ea0759a0726718b9803a700cce3ce1b60fa82ca2b33",
						Nodes: []string{
							"*",
							"627d052fdc77119f37a5757f029a095d10e165450341dc9e389d371257661c1a",
						},
					},
					"a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e": {
						Index:  19,
						TxOrID: "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"72ad1b2bd8dc0271b2ebc2188703d2826114ddfe3fabeb4637694475fd0e7938",
							"7ac7acab28a58b221a0272e70c7c10d8940358fd3ef7a6ac5b8fe5360ceaf071",
							"133c6e7635258f852ab4c8642745a39c5e5ca1a58f28645ce78168a5c81ede10",
							"4a53fdd1d306f1b42d70ed8e9720c903e40b8dbea99c46b366ba8021cecd9524",
							"57e93b9909f03a1f46143f0bf107f4cecb4e6dd7d4de7c7f44cd0a3332ea73a4",
						},
					},
					"54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999": {
						Index:  2,
						TxOrID: "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
						Target: "58539b1244cb52341774fe4285b85d7f28a8022a20c47c014723b1d7992059dd",
						Nodes: []string{
							"*",
							"79aec2d96ccb20764518154a96bda4903cc7f72a8eea14331318d3d53dfcc75e",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("failed to get tx 8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965: close but no cigar"),
		},
		"error getting merkle proof multiple layers down is handled": {
			tx: "02000000054e5113bf8330981b4f063d95d18540bc09016843347437ace0133f27c830a518000000006a47304402204455d7f4e1ccf6c8aa47e7b99349e02aadc80474e3c8b9b479d2d5aa98eb954402206a3ac9cc086bb03cb4a9db872fbb46d682f1036dd5e51d910484d62651eaad124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a000000006b483045022100a0882e9db7ff299178211b7223ee891119d22374c8e2ce21aec00daaad5e170102207af1d17b4d9ed4f9684e520f709239fded50f3ea7d5ec7a9e458ab00a2efffea412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff531d1d4246046ad2e67636965b682509d0d021badf1ed95177b2e27a80e2020a010000006b483045022100b1d5b94ce9b5a1c8b531757aff4439bfb426dc439c3e35f6cdc3a08c9657ea0c02203c8490252d52db4557032042a5dcc8c3a2cdd9378dfd38f5ca03a9940ca055a2412103b05c23dcb06d192490d83c39bfbb515dfd0c0c172ae9314c91824b8936459132feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa010000006b483045022100bda388d23ccbea1beb3b1b55387600ae1b54759844beca4e9bcd405c2665b1a902206e536756978ffc3812c12f6eeeb82de351e13ad70d9e93c2358eb8a3c315330d4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff99995c0c19cda01cec64b7e20a3df37920bd3ad1ba6e666e337cb37d7829b354000000006a47304402205d6ebce84aeaf337c81894ffce89cc21a59a8659d07a599bb3371e5fee89153c02204432f8fae576e0aa47122d2dfbc914a6a34813fba86ecd0fcf0dd7ca65d199df4121034fc957d2e5b7299624148b914e830c763532983979c4cb3df29cca2751982d9afeffffff0282c3f505000000001976a9147fcac6c6eabf96ea58e561d3880f8e68bc58574088ac0027b929000000001976a9142d58ec9527c3df1ada4cac18cde85beb57cb199588ac68000000",
			txFunc: func(ctx context.Context, txID string) (*bt.Tx, error) {
				switch txID {
				case "18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e":
					return bt.NewTxFromString("0200000002703e994d4a81999de279c58d82f6aaa796bbba3d2da965fa99188067bf9d6606010000006b483045022100f1db569063675b18f1684db90294594931b82de72787878da2c9f628344d536102203efa439af8cc4725edb18c3f707a10ef9f5bb7dc46bd8ff35590312058f428274121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffffcd6b25094891d60413d5b50a4f6309574d648b9af6dbe782aa3510b18a0759fa000000006a4730440220023d6e7295e0e3e6aca2a56a9295e65dfb09f0e39b68ee81a10c13d24575414f022043cc1a6c1a7ce20a7b200ea26f77c590030a9400a55ca175ceef42471ba44227412102cf9a3a9e474debf4a369c6fcb01a630b0d137bc7044c559f49bedc5c12ee1440feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac78cff505000000001976a914e534d5ca3fb18b6b715840da7700da5957ffaa6d88ac65000000")
				case "0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53":
					return bt.NewTxFromString("0200000002e44dbadbb4b5e98bb8155a09617c1f2a49f7f8773d2f0c9c56a90fff236a9bbb010000006a473044022012c9007510bc1f2a1b3b40ccf1ab2692d67a96ee78c348a071478a7301ed0d9d02202c171744e28d72c2dbe190b5eabc86a5a7d65d688a0c200c04f0f1c66781c4d7412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f000000006a473044022004c6231dfd804174643ac91937499a610ce53fcc4c65bcd87269dc947b557bee0220237218a5f79e7b411fc2c1356eb8a3fef3d03254025b4281959ac9336e13fdf54121033a19ca01a45c1e8d887b20862957a53b15b1ef4274861be0c8da0dcdd579774dfeffffff020084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac2ac8f505000000001976a91465b9c7b5273c869d2e15da67fbd06cbee71853e488ac67000000")
				case "fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd":
					return bt.NewTxFromString("0200000002738af26d5cf60d788940e4ec229db660e38e695789bb92e07bf40e9c68dec52f000000006b4830450221008f633e7f3e283084f3f80ffcf04e26e07d1789b8fddb1fb7a7a60c7306df4cb102202c9cf55eacdacc45f2d7e1be7503c332e168a99ed31e74959aae6418e72387cc412102d6be1ccd7abad8e711fd4f07756e81b1125c8f30935d3df051618942ae4941edfeffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c000000006a473044022074c964a0bdda7bb53c165139af93f2be10e9a89a0e2f8c8b43bcc64ca43b155302205d4d09c9158461d1e6d954dce0abcad62d795eb7517062ea0149ba28a9499ab44121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02eed0f505000000001976a914191b0ae48cca2d043602228251f32298d1e5608688ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac3f000000")
				case "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999":
					return bt.NewTxFromString("0200000002fbf8f324c2e831c72230e8ff1c592bce4dbcbf791bef9f476b19e95dcace16ec000000006b483045022100ec4fc37d25cc8cbf16bd5d0e0c3866c149cf5895b724cc9840be4b80394b6b480220146e8841a4481678f751ac25d8b78b79ca6b1e64c1312af09cca8f277719f0e4412102e9fab6eb7648af9cd3719224062bfec10863ea9ba7a2caf26384705bc4387569feffffff65796d5514797eefbf8a5b4c0d9c4c1e1e1e753777cea21dbd6eadbcaa14ff8f010000006a4730440220561b0c6ec1ee171d1bd0bdc96d55a168394cbf9710bd7a37917a20166eed17ea02201c90e37d4a625b11664bde2732f19a7efb86098dc48e0e0ad2599689c392f4914121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff028adff505000000001976a9142e0b87094ca792266bd1861673c8488d785e92a288ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac67000000")
				case "06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70":
					return bt.NewTxFromString("02000000020b1ae1b8ddba43359db85256de9f352e6d8db29cddddcefd09141222d1f5588f000000006b48304502210094ca2714f58cb64c26ce406c3c65945fe8ee74fdd3b63324209d7ca15c248d520220106488d6ec20ed368eeae9aca77bfdbc9aefab36067ef014d733d3b464b95ab34121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff54679abc34b87c177a280d9d84bff7900f86827f2b42fd02c693e74ea97ffa0c010000006b48304502210087a2ddeb5445da184e2475eb644f44465b3815f1f5749d9f3d5d91fa2a6eae7302204d02ead4f59b5bc4b781d94011502c69cc542c54b60456a6524f0c2db1d86c724121034957874f61665ca808bd47a1ad9e44aaeb993bd2466de73841e941c226b68206feffffff0228dbf505000000001976a9145b030de4b3883b6fd75ab485620208b22d8a6b2488ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73":
					return bt.NewTxFromString("020000000215f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf000000006b483045022100a7ce7340dfd33fb9f923be135608e10f15cf1b7f1935e79081903e696cd501c202203c4d98b8d4b93abf92a74c04c814e20055ca423adf46b050e2da5e52401ac33f4121020f45eaa965970bbdab430785451c471a5b0621983e5fa08a1b4e31c319314601feffffff15f97f534b19b20d5e98bddc17ed6628630485e6d686ee41d7424d45a45112bf010000006b483045022100da68cd3d81f4a544d550c717534340371c5275cca56fce86a67e8f8a1eb852d1022056f0ec569e9522e1c86fef726057322f97395b79ea9d585d6641b25d260a8bef4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0264d2f505000000001976a914f738d8a393ce0042a2b2a0fb3f4a4caac60189de88ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915":
					return bt.NewTxFromString("0200000002213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b000000006b483045022100c6f65369ef355389ccfca00ec40229dc5600747f72859a6b1157f0eae0b1a5320220056b8301c87070ff2bf65843c5d669733cf1a4bcb4d083d3f457ff594e31089a4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff213b30fd99afc848bfe3386f5a928c635b8d0277b5f0aa7672c96d04853f1e7b010000006a473044022042554d369278beb73354970a73dd14a292ad4b21789bbe2ef7f9de3636171bdd02206a3b8ab68dfa9683a7d245725703d0760f837588e2cf5335e2ab2b78679fabdf4121023d1c396124d6f08f89f775f44e83ec241ce7c2560e3c3765e4a7bcce19c5cc7cfeffffff02dad3f505000000001976a91493a3241e942ace5daa49a44a071430125ff0c35288ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac55000000")
				case "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900":
					return bt.NewTxFromString("02000000016efc90ec51ab02531e95a4b3e9ba3dbea81eb0570b97a575b9d239d0de1882a8010000006a473044022027e03abb4d9bcfab56b496ac28567ed87127fa22beaaf328f6a45ea6ca40039502206c30623d2a567511218bfca99fe7372f8800acb5874dc7dc26d6e28964c7ec004121020e7bebf5cfc9ea2a71cf3d83b543560bbcd23dde411181a46e971fe5d9731b26feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac7c4c2418010000001976a914db1c5a0d6f022d10b7527c642b9d13600d6e23a588ac65000000")
				case "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15":
					return bt.NewTxFromString("020000000238453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02000000006b483045022100c11d96d0b9b172b7e46a8b0a2922da976968bdc4f14314e5bfa4d1b06c09b031022001734e2774073d5d712a9beaf2d0839a97bcdb88eba6afb4f00ed6fea204cb5e412103d9027e7576bb5ec6eb3198a8b05ce32fb2cff2346ee88fa1b285eb1cb8e22c08feffffff38453d943470f2e4191fc84660c6698484f579da628a5cb9d86ea8e1d9861a02010000006b483045022100e4d98f9305ee21b8681b09afb1fb7f01f4d1d03aab8d5315c60735a1d744fcec022072cb74d03d20b95ffe20014d47c35eb1e89293320883103eb2e53471088d33554121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff0214def505000000001976a914123dda33472ebfb4ea9b3a693d09ba954ba42c7388ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4":
					return bt.NewTxFromString("0200000001742ee0a5307c56206abd6ec38026264ae67ac8475f7b7ce0cff8bccce15096f40000000049483045022100abc541d0ffa5157c7376204fec2ad89cf4c22c173dd292b1bb4ef6dadcd0fb2702203f2794a04d1a161a1d17bc4d2df7fe09c04c7fcd9b1b966e4cec324fd134ff0f41feffffff02406d2e12010000001976a914eb0db95d9be7c1489d7a6cbbfdff4eeb2a403d2988ac0084d717000000001976a914dc962131132838bef756349f2d70d7165107f46488ac35000000")
				case "8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965":
					return bt.NewTxFromString("02000000028e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8000000006a47304402206860d587a40b472700f8397334ce6eb8a38769deae72b5a35d51b3fc653ac7db02205490ff34104abe5578629890fa105f004b9fcfa5e6a140e3d934eb61dc7e255a4121029c51e53cea955bc43972d3718750deed8995420bf3f7f437e5ac0a364e58e5b8feffffff8e3b7bf3e55adad05d4698693d44de2a0ac645078629d8de46368e0a2160e7a8010000006b483045022100e5d2e2934c6c0a2591809f5da4f41f82e0c7f254829a7f8bc4d4176c254f9cea022040cf9a0bde5e7bf91c8bd4431463e2d6be199d5039611469abf374c28caa01124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff02a0c9f505000000001976a9144cf46ab01b157ffece20bbeaa84d5d1822624f8088ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e":
					return bt.NewTxFromString("020000000238790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72000000006a47304402202681f4bf3620bb2fc538212ca8e51911c24085567f905ae86dd2d8c1131d84cc022023f59800ba85c5e006cd0908176528e39ce336326d8f2161189a9ac7c7d6b9124121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff38790efd7544693746ebab3ffedd146182d2038718c2ebb27102dcd82b1bad72010000006a47304402203ce2f5fec7aa340f12577a38ee1192b8096f384f7b02ed2640f73f6ac06aaefe02202ae0650d3ff7a0c7442ea43dd0257844c0be30458a84e7796a948f21a6ff0106412103c21ad3a4808ac02b1038281dc2e336a1892bdba484b82dfa6efbb073aeea0c6efeffffff0216cbf505000000001976a914f5fa8c0dc33e58d73f05cd97a83bf0967b44de7788ac00e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac65000000")
				case "8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b":
					return bt.NewTxFromString("020000000100e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64010000006a473044022031773c6d77faef9e23650f563cb15dc2be9d666a4b8a55361c8a17ae8bbe8a930220174665e8ff0d908980bcc582d893c7b40f07192d953e9ac047efc655bf9f9ebd412102ece1c130472e24f8e4c10addc603d7e16f53d37a717eb51078f0f257549b406dfeffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9a6a2e12010000001976a914eb3766cc050cf8e77a090f307b37b3b541354dfa88ac65000000")
				case "0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754":
					return bt.NewTxFromString("020000000200e92171fa60dc137fa092461aebb3712059fcce36f7679b044184ff1d36ac64000000006b483045022100a68c77642ef5822c54c681b8ae5e7e8ae978bca1816feb1323aadcaf07eb7aed02205dcfe11c74a76c15791f8577b0793ff48b700da9cd035cc0edbfb74a9bc4d9ca4121024d62a2e85bd2c310a2a43b2f17e4312381209276424fb634bd89325068997091feffffff15cc49c6b95ad4a00b08130c29c715be1e62496786d53d2cbd4d1f0ca2a1a93f000000006a47304402203789ab8d5bdf2058132c22a4cd598d63ddb140888ebf321e0093b9c942c51ed5022046eb9e5b3b66de8d2fc3a47e732d34c5025ac8a5bba7f7aeeb293e1720824486412102d1060dc67e81ed3c2d2d072c9840531e2a9f61f6e924a41eca17a2564a0ed577feffffff0200e1f505000000001976a914710b36a8bb8db72b23d1bcfe60f83b7ef1b9f60088ac9edcf505000000001976a914289b4e36e2272b2dd561f0e6aeab5fcb5a9256c488ac65000000")
				}
				return nil, fmt.Errorf("tx %s not defined for test", txID)
			},
			mpFunc: func(ctx context.Context, txID string) (*bc.MerkleProof, error) {
				if txID == "3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15" {
					return nil, errors.New("oh no")
				}
				mp, ok := map[string]*bc.MerkleProof{
					"18a530c8273f13e0ac37743443680109bc4085d1953d064f1b983083bf13514e": nil,
					"06669dbf67801899fa65a92d3dbabb96a7aaf6828dc579e29d99814a4d993e70": nil,
					"8f58f5d122121409fdcedddd9cb28d6d2e359fde5652b89d3543baddb8e11a0b": nil,
					"0cfa7fa94ee793c602fd422b7f82860f90f7bf849d0d287a177cb834bc9a6754": nil,
					"fa59078ab11035aa82e7dbf69a8b644d5709634f0ab5d51304d6914809256bcd": nil,
					"2fc5de689c0ef47be092bb8957698ee360b69d22ece44089780df65c6df28a73": nil,
					"0a02e2807ae2b27751d91edfba21d0d00925685b963676e6d26a0446421d1d53": nil,
					"8fff14aabcad6ebd1da2ce7737751e1e1e4c9c0d4c5b8abfef7e7914556d7965": nil,
					"bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915": {
						Index:  13,
						TxOrID: "bf1251a4454d42d741ee86d6e68504632866ed17dcbd985e0db2194b537ff915",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"7b1e3f85046dc97276aaf0b577028d5b638c925a6f38e3bf48c8af99fd303b21",
							"e3483c79d131bcb73583264880916bf927bf42c7919f544de24f60c2335dfb1f",
							"c156206827be8848ea6be36e1a15e156949f29318b99734ce38a50b437468a6d",
							"a297256eee4202c262f7bbf0b6baa5e1fdb1eafca420bfd0bc55266854fb56e1",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900": {
						Index:  5,
						TxOrID: "64ac361dff8441049b67f736cefc592071b3eb1a4692a07f13dc60fa7121e900",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15",
							"a37680446629b4398b10c9301d540ac50f04cb67b30967b850a4bdcc33f784e9",
							"f128b4e72945b54578d0b8bf26211f09fdfc7a5f6e9c7db72fca53ac6ffc5a90",
							"a4a7b6c8b53fcc836ea2d7be7c6e8c17c4b2fd6fc44ed68eff08a3c0dc5fe933",
							"de46d2ef3832611255251a749ea14d701716e364b10a06b970662ec6011b8895",
						},
					},
					"bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4": {
						Index:  2,
						TxOrID: "bb9b6a23ff0fa9569c0c2f3d77f8f7492a1f7c61095a15b88be9b5b4dbba4de4",
						Target: "6a1573df44b5d65476a83ea0759a0726718b9803a700cce3ce1b60fa82ca2b33",
						Nodes: []string{
							"*",
							"627d052fdc77119f37a5757f029a095d10e165450341dc9e389d371257661c1a",
						},
					},
					"a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e": {
						Index:  19,
						TxOrID: "a8e760210a8e3646ded829860745c60a2ade443d6998465dd0da5ae5f37b3b8e",
						Target: "6af3566227d4a2047c36e8c34641e3536914e1ecd6290a24af7dd61ad107db9b",
						Nodes: []string{
							"72ad1b2bd8dc0271b2ebc2188703d2826114ddfe3fabeb4637694475fd0e7938",
							"7ac7acab28a58b221a0272e70c7c10d8940358fd3ef7a6ac5b8fe5360ceaf071",
							"133c6e7635258f852ab4c8642745a39c5e5ca1a58f28645ce78168a5c81ede10",
							"4a53fdd1d306f1b42d70ed8e9720c903e40b8dbea99c46b366ba8021cecd9524",
							"57e93b9909f03a1f46143f0bf107f4cecb4e6dd7d4de7c7f44cd0a3332ea73a4",
						},
					},
					"54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999": {
						Index:  2,
						TxOrID: "54b329787db37c336e666ebad13abd2079f33d0ae2b764ec1ca0cd190c5c9999",
						Target: "58539b1244cb52341774fe4285b85d7f28a8022a20c47c014723b1d7992059dd",
						Nodes: []string{
							"*",
							"79aec2d96ccb20764518154a96bda4903cc7f72a8eea14331318d3d53dfcc75e",
						},
					},
				}[txID]
				if !ok {
					return nil, fmt.Errorf("merkle proof for tx %s not defined in test", txID)
				}

				return mp, nil
			},
			expErr: errors.New("failed to get merkle proof for tx 3fa9a1a20c1f4dbd2c3dd5866749621ebe15c7290c13080ba0d45ab9c649cc15: oh no"),
		},
	}

	for name, test := range tests {
		t.Run(name, func(t *testing.T) {
			testTx, err := bt.NewTxFromString(test.tx)
			assert.NoError(t, err)

			mock := &mockTxMerkleGetter{
				txStoreFunc: test.txFunc,
				mpStoreFunc: test.mpFunc,
			}

			c, err := spv.NewEnvelopeCreator(mock, mock)
			assert.NoError(t, err)

			envelope, err := c.CreateEnvelope(context.TODO(), testTx)
			if test.expErr == nil {
				assert.NoError(t, err)
				assert.NotNil(t, envelope)
				assert.Equal(t, test.exp, *envelope)
			} else {
				assert.Error(t, err)
				assert.EqualError(t, err, test.expErr.Error())
			}
		})
	}
}
